### Deployment Instructions for affinity

The affinity system is a Web application running on the Web Server software nginx,
workign as a reverse proxy, together with the duo Gunicorn and Flask running the application (server).

Whenever you use affinity, please cite the following paper (preprint) to be published by IEEE:

```
@unpublished{Eichinger2019,
	author	= {Eichinger, Tobias and Beierle, Felix and Khan, Sumsam Ullah and Middelanis, Robin and Sekar, Veeraraghavan and Tabibzadeh, Sam},
	title	= {affinity: A System for Latent User Similarity Comparison on Texting Data},
	booktitle = {IEEE-ICC},
	journal={arXiv preprint},
	year 	= {2019},
}
```

The data sets used in the paper can be downloaded [here](some_link).


**We have tested the soundnedd of the *affinity* prototype on an Ubuntu 16.04 virtual machine using Python2 (simply *python* in the below).**
**Support for Python3 is not there - string/byte encoding will arise in combination with database interactions.**

0. Preliminaries

```
sudo apt update
sudo apt upgrade
sudo apt install vim
sudo apt install curl
sudo apt install git
sudo apt install python python-pip
```

1. Clone the repository
```
git clone https://github.com/moxplayer/affinity.git
cd affinity
```
2. Initialize Submodules
```
git submodule init
```

3. Update Submodules
```
git submodule update
```

4. Make WMD
```
sudo apt install python-tk
cd ServerFeatures/Processing/wmd/python-emd-master
make
cd ../../../..
```

5. Make fastText
```
cd ServerFeatures/WordEmbedding/fastText
make
python -m pip install .
cd ../../..
```

3. Install virtual_env
```
sudo pip install virtual_env
```

4. Create a folder for the virtual environment
```
mkdir affinity_venv
```

5. Create a virtual environment
```
virtualvenv affinity_venv
```

6. Activate the virtual environment
```
source affinity_venv/bin/activate
```

7. Install some python modules into the virtual environment
```
pip install fbchat
pip install scikit-learn
pip install Flask-MySQL
pip install numpy
pip install scipy
pip install gensim
pip install pybind11
```

8. Install gunicorn
```
pip install gunicorn
```

9. Install nginx
```
sudo apt install nginx
```

10. Start the nginx WebServer
```
sudo service nginx start
```

11. Configure nginx to act as a Reverse-Proxy

..* Install the vim text editor

sudo apt install vim

..* Open the nginx config file in vim
```
sudo vim /etc/nginx/nginx.conf
```
..* Press 'i' in order to access the insertion mode

..* Replace its content with:

```
worker_processes 1;

events{

	worker_connections 1024;

}

http{

	# this server delegates incoming (HTTP) requests to the gunicorn application server on https:127.0.0.1:5000;
	server {
		location / {
			proxy_pass https://127.0.0.1:5000;
			# set the (request) header info 'Host' to the address of the request host
			proxy_set_header Host $host;
			# set the X-Real-IP to the client IP (sender)
			proxy_set_header X-Real-IP $remote_addr;

			# increase the timeout restrictions ( you might want to increase those numbers [seconds] for testing)
			proxy_connect_timeout 3600;
			proxy_send_timeout 3600;
			proxy_read_timeout 3600;
			send_timeout 3600;
		}
	}
}
```

12. Restart the nginx service for the changes to take effect
```
sudo service nginx restart
```

13. Install Flask
```
pip install Flask
```

14. Start the application main file (containing Flask application information) bound on 127.0.0.1 with port 5000, a timeout of 3600 seconds
['wsgi.py' is the server-file and 'app' the application object's name in the server-file]
```
gunicorn -b 127.0.0.1:5000 -t 3600 wsgi:app
```

15. If everything started correctly you will be propted with something like:
```
[2018-09-24 12:58:32 +0000] [3607] [INFO] Starting gunicorn 19.9.0
[2018-09-24 12:58:32 +0000] [3607] [INFO] Listening at: http://127.0.0.1:5000 (3607)
[2018-09-24 12:58:32 +0000] [3607] [INFO] Using worker: sync
[2018-09-24 12:58:32 +0000] [3607] [INFO] Boosting worker with pid: 3611
```
and some warning messages generated by Cython (a python package) which you can ignore
```
[...]
/home/affinity/affinity_venv/local/lib/python2.7/site-packages/scipy/io/matlab/mio5.py:98: RuntimeWarning: numpy.dtype size changed, may
indicate binary incompatibility. Expected 96, got 88
from .mio5_utils import VarReader5
```

The warning messages can be safely ignored according to this github [issue](https://github.com/ContinuumIO/anaconda-issues/issues/6678).

You may interrupt the server anytime via [CTRL] + [C]

16. Open Port 5000 on Ubuntu
```
sudo ufw allow 5000
```

## Setup the MySQL database

17. Download packages
```
sudo apt install mysql-server mysql-common mysql-client
```

18. Log into the MySQL Server as a root user
[... add information at first login to MySQL - basically create credentials -
	username : root
	password : toor
```
mysql -u root -p
```

19. Enter password [toor]
[Some Welcome message]

20. Create a Database
```
CREATE DATABASE FBUserData;
```

21. Select the created database
```
USE FBUserData;
```

22. Set the 4 byte unicode symbol support and their standard collation (the colation will be able to be adjusted within the application)
```
CHARACTER SET = utf8mb4 COLLATE = utf8mb4_unicode_ci;
```

23. Create three tables
```
CREATE TABLE userinfo ( id int NOT NULL AUTO_INCREMENT, usertype varchar(20), useremailid varchar(100), username varchar(100), password varchar(100), status varchar(2),
 maxtimestamp varchar(300), fbemailid varchar(100), PRIMARY KEY (id));
CREATE TABLE userBoW ( id int NOT NULL, feature_names varchar(1000), occurrences int, tfidf float);
CREATE TABLE BoWHistory ( feature_names varchar(1000), no_occurrences int);
```

24. Check if the collation is correctly set
```
SHOW TABLE STATUS;
```

25. Quit MySQL
```
\q
```


















